<!--

	Text v0.0.1

	created and maintained by https://ihasq.com

	editor style settings are modifiable at /html/body/style

-->
<!DOCTYPE html>
<html>
	<head>

		<title>Text (unsaved)</title>

		<meta charset="utf-8"/>

		<style>

			* {
				box-sizing: border-box;
			}

			html {
				height: 100vh;
				width: 100vw;
			}

			body, div.wrapper, #editorGrid {
				height: 100%;
				width: 100%;
			}

			html, body, div.wrapper, #editorGrid, #editorLine {
				padding: 0px;
				margin: 0px;
				user-select: none;
			}

			div.wrapper {
				position: relative;
			}

			#editorGrid, #commandline, #scrollTopBar {
				position: absolute;
			}

			#editorGrid {
				z-index: 0;
				display: grid;
				grid-template-columns: var(--editor-lineNumber-width) auto;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}

			#editorLine {
				font-family: var(--editor-font-family);
				font-size: var(--editor-font-size);
				tab-size: var(--editor-tab-size);
				line-height: var(--editor-line-height);

				color: #556;

				margin: 0px;
				padding: 6px;
			}

			#editor {

				font-family: var(--editor-font-family);
				font-size: var(--editor-font-size);
				tab-size: var(--editor-tab-size);
				line-height: var(--editor-line-height);

				background-color: #fff;
				color: #000;

				overflow: hidden;

				height: max-content;
				min-height: 100%;

				margin: 0px;
				padding: 6px;

				cursor: text;

				user-select: auto;

			}

			#editor:focus {
				outline: var(--editor-focus-outline);
			}

			#commandline {
				z-index: 2;
				top: 10px;
				left: 30%;
				right: 30%;
				width: 40%;
				
				border-radius: 3px;
			}

			#scrollTopBar {
				z-index: 1;
				right: 0;
				width: 4px;
				height: 50%;
				background-color: #555;
				opacity: 70%;
				border-radius: 2px;
			}

			#editSpan:focus {
				outline: none;
			}
		</style>

	</head>

	<body>

		<!-- editor style -->

		<style>

			* {
				--editor-font-family: Consolas, 'Courier New', Courier, Monaco, monospace;
				--editor-font-size: 14px;
				--editor-tab-size: 4;
				--editor-line-height: 16px;

				--editor-focus-outline: none;

				--editor-lineNumber-width: 40px;

				--editor-scrollBar-activeWidth: 16px;
				--editor-scrollBar-minimalWidth: 4px;
			}

			/** #editor::selection { ... } */

			#commandline {

				font-family: Consolas, 'Courier New', Courier, Monaco, monospace;
				font-size: 12px;

				height: 26px;

				border: none;

				padding: 7px;

				background-color: #333;

				color: #fff;

				box-shadow: 0 5px 25px 0 rgba(0, 0, 0, .5);

			}

			#commandline:focus {

				outline: none

			}

		</style>

		<div class="wrapper" id="activeWrapper">
			<div id="editorGrid">
				<pre id="editorLine"></pre>
				<pre id="editor"></pre>
			</div>
			<div id="scrollTopBar"></div>
			<input id="commandline" title="type 'help' for more info"/>
		</div>

		<script type="text/javascript">

			"use strict";

			{
				window.editor = {

					userState: "insertion",

					element: {
						surface: document.getElementById("editor"),
						commandline: document.getElementById("commandline"),
						editorGrid: document.getElementById("editorGrid"),
						editorLine: document.getElementById("editorLine"),
						editSpan: document.getElementById("editSpan")
					},

					file: {
						fileName: "",
						fileHandle: null,
					},

					buffer: {
						currentControlQueue: [],
						textData: "",
						instances: {
							0: {
								edit: {
									history: [
										{
											actionType: "insert"
										}
									]
								}
							}
						}
					},

					command: {
						arg: [],
						query: {

							"save"() {
								globalThis.editor.action.save();
							},

							"open"() {
								globalThis.editor.action.open("UTF-8");
							},

							"new"() {
								globalThis.editor.action.new();
							},

							"about"() {
								window.open("./about.html", { target: "_blank" })
							},

							"alert"() {
								alert(globalThis.editor.command.arg.join(" "))
							},

							">"() {

								globalThis.editor.command.query[globalThis.editor.command.arg[1]]()

							}

						},
						history: [],
						historyIndex: 0,
					},

					editorProperty: {
						editorLine: 0,
						focusLine: 1,
						lastKeyDownedTimestamp: -1,
						currentBufferId: -1,
						minimalEditorLineDigits: 3
					},

					keyProperty: {
						ctrl: false,
						shift: false,
						alt: false
					},

					selectionProperty: null,

					controlEvent: [

						[
							"beforeunload", event => {
								event.preventDefault();
								event.returnValue = "";
							}, { passive: false }
						],

						[
							"wheel", event => {
								event.preventDefault();
								this.buffer = Object.create(null);
								this.buffer.isShiftUnpressed = !globalThis.editor.keyProperty.shift;
								this.buffer.top = (this.buffer.isShiftUnpressed)? "deltaY" : "deltaX";
								this.buffer.left = (this.buffer.isShiftUnpressed)? "deltaX" : "deltaY";
								globalThis.editor.element.editorGrid.scrollTop += event[this.buffer.top];
								globalThis.editor.element.surface.scrollLeft += event[this.buffer.left];
							}, { passive: false }
						],

						[
							"keydown", event => {

								switch(event.code) {
									case "F1":
										event.preventDefault();
										globalThis.editor.userState = "command";
										globalThis.editor.element.commandline.style.visibility = "visible";
										globalThis.editor.element.commandline.value = "> "
										globalThis.editor.action.setFocusTo(globalThis.editor.element.commandline);
									break;
								}

								switch(event.target.id) {

									case "editor":
										globalThis.editor.keyProperty.ctrl = event.ctrlKey;
										globalThis.editor.keyProperty.shift = event.shiftKey;
										globalThis.editor.keyProperty.alt = event.altKey;
										if(globalThis.editor.keyProperty.ctrl) {
											switch(event.code) {
											
												case "KeyS":
													event.preventDefault();
													globalThis.editor.action.save();
												break;
												case "KeyO":
													event.preventDefault();
													globalThis.editor.action.open();
												break;
												case "KeyZ":
													event.preventDefault();
												break;

											}
										
										} else {
										
											switch(event.code) {
											
												case "Tab":
													event.preventDefault();
													globalThis.editor.action.insert("\t");
												break;
												case "Backspace":
													if(globalThis.editor.element.surface.textContent.length == 1) {
														event.preventDefault();
													} else {
														globalThis.editor.action.refreshEditorLine();
													}
												break;
											
											}
										
										};
									break;

									case "commandline":

										switch(event.code) {
											case "Enter":
												event.preventDefault();
												globalThis.editor.action.cmd(globalThis.editor.element.commandline.value);
												globalThis.editor.element.commandline.value = "";
											break;
											case "Escape":
												event.preventDefault();
												document.activeElement.blur();
												globalThis.editor.element.commandline.style.visibility = "hidden";
												globalThis.editor.element.editSpan.focus();
											break;
										
										}
									break;

									case "editSpan":

										switch(event.code) {
											case "Enter":
												event.preventDefault();
												globalThis.editor.action.refreshEditorLine();
											break;
										}

									break;

								}

							}, { passive: false }
						],

						[
							"keyup", event => {
								switch(event.target.id) {
									case "editor":
										globalThis.editor.keyProperty.ctrl = event.ctrlKey;
										globalThis.editor.keyProperty.shift = event.shiftKey;
										globalThis.editor.keyProperty.alt = event.altKey;
										
									break;
								}
							}, { passive: true }
						],

						[
							"mousedown", event => {
								switch(event.target.id) {
									case "editor":
										document.activeElement.blur();
									break;
								}
							}
						],

						[
							"mouseup", event => {
								switch(event.target.id) {
									case "editor":
										globalThis.editor.element.editSpan = document.getElementById("editSpan");
										globalThis.editor.element.editSpan.focus();
									break;
								}
							}
						]
					],

					action: {

						save: async () => {
							try {

								this.buffer = Object.create(null);

								if(!globalThis.editor.file.fileHandle) {
									globalThis.editor.file.fileHandle = await window.showSaveFilePicker({
										types: [
											{
												description: "Text file",
												accept: { "text/*": [] }
											}
										]
									});
								}
								this.buffer.writable = await globalThis.editor.file.fileHandle.createWritable();
								await this.buffer.writable.write(globalThis.editor.element.surface.textContent);
								await this.buffer.writable.close();
							} catch {}
						},

						open: async (readAs) => {
							try {

								this.buffer = Object.create(null);

								[globalThis.editor.file.fileHandle] = await window.showOpenFilePicker({
									types: [{
										description: "Text file",
										accept: {
											"text/*": [],
											"application/*": []
										},
									}],
									excludeAcceptAllOption: true,
									multiple: false
								});
								document.title = globalThis.editor.file.fileHandle.name;

								this.buffer.result = new FileReader;
								this.buffer.result.readAsText(await globalThis.editor.file.fileHandle.getFile(), (readAs || "UTF-8"));
								this.buffer.result.onload = event => {
									globalThis.editor.element.surface.textContent = event.target.result;
									globalThis.editor.action.refreshEditorLine();
								};

								globalThis.editor.file.isOpenedFromFS = true;

							} catch {}
						},

						new() {
							globalThis.editor.file.fileHandle = null;
							globalThis.editor.element.surface.innerHTML = "<span class=\"lineWrapper active\"><span id=\"editSpan\" contenteditable=\"plaintext-only\"></span></span>";
							globalThis.editor.action.refreshEditorLine();
						},

						cmd(arg) {
							if(typeof arg === "string") {
								globalThis.editor.command.arg = arg.split(" ");
								globalThis.editor.command.history.unshift(globalThis.editor.command.arg);
								globalThis.editor.command.query[globalThis.editor.command.arg[0]]();
							}
						},

						setCaretPos(anchorOffset) {
							window.getSelection().setPosition(globalThis.editor.selectionProperty.anchorNode, anchorOffset);
						},

						insert(string) {
							globalThis.editor.selectionProperty.anchorNode.insertData(globalThis.editor.selectionProperty.anchorOffset, string);
							globalThis.editor.action.setCaretPos(globalThis.editor.selectionProperty.anchorOffset + 1);
							globalThis.editor.action.refreshEditorLine();
						},

						setFocusTo(document) {
							setTimeout(document.focus(), 0);
						},

						refreshEditorLine() {

							setTimeout(() => {

								this.buffer = {
									matchedLine: document.getElementsByClassName("lineWrapper").length,
									lineDOM: ""
								};

								console.log(this.buffer.matchedLine)

								if(!(globalThis.editor.editorProperty.editorLine == this.buffer.matchedLine)) {

									this.buffer.lineDigits = this.buffer.matchedLine.toString().length;
									if(this.buffer.lineDigits < globalThis.editor.editorProperty.minimalEditorLineDigits) this.buffer.lineDigits = globalThis.editor.editorProperty.minimalEditorLineDigits;

									globalThis.editor.editorProperty.editorLine = this.buffer.matchedLine;

									for(let i = 1; i <= this.buffer.matchedLine; i++) {
										this.buffer.lineDOM += ( " ".repeat(this.buffer.lineDigits - i.toString().length) + i + "\n" );
									};
									globalThis.editor.element.editorLine.textContent = (this.buffer.lineDOM += "\n".repeat(Math.ceil(document.documentElement.clientHeight / 16) - 2));

								}

							}, 0);

						},

						createInstance(init) {
							globalThis.editor.buffer.push(init)
						},

						pushHistory() {

						}

					},

				};

				window.onload = () => {

					editor.element.commandline.style.visibility = "hidden";

					editor.controlEvent.forEach(index => window.addEventListener(...index));

					editor.action.setFocusTo(editor.element.surface);

					editor.action.new();

					editor.action.refreshEditorLine();
				}

			};

		</script>
	</body>
</html>